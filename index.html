<!-- ============================================================
     –ß–ê–°–¢–¨ 1 –∏–∑ 3: DOCTYPE, HEAD, CSS-–°–¢–ò–õ–ò
     –°–æ–¥–µ—Ä–∂–∏—Ç: —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞, –º–µ—Ç–∞—Ç–µ–≥–∏, –≤—Å–µ —Å—Ç–∏–ª–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
     –°—Ç—Ä–æ–∫–∏: 1-280
     ============================================================ -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        /* –õ–æ–≥–æ—Ç–∏–ø */
        .logo-container {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        
        .logo-text {
            font-size: 14px;
            font-weight: bold;
            color: #f39c12;
        }
        
        /* –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .login-box p {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #f39c12;
        }
        
        .input-group input::placeholder {
            color: #888;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: #fff;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: #fff;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal-print {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        /* –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω */
        .main-screen {
    display: none;
    padding: 20px;
    padding-left: 80px;
    padding-top: 80px;
    max-width: 1400px;
    margin: 0 auto;
}
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* –§–æ—Ä–º–∞ */
        .form-section {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .form-section h2 {
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .datetime {
            font-size: 14px;
            color: #aaa;
            font-weight: normal;
            margin-left: auto;
        }
        
        /* –¢–∞–±–ª–∏—Ü–∞ */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }
        
        td select,
        td input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
        }
        
        td select:focus,
        td input:focus {
            outline: none;
            border-color: #f39c12;
        }
        
        td select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .col-num { width: 40px; text-align: center; }
        .col-dept { width: 150px; }
        .col-loc { width: 130px; }
        .col-motor { width: 120px; }
        .col-inv { width: 80px; }
        .col-manuf { width: 100px; }
        .col-power { width: 70px; }
        .col-speed { width: 80px; }
        .col-reason { width: 130px; }
        .col-del { width: 40px; }
        
        .btn-delete-row {
            background: rgba(231, 76, 60, 0.2);
            border: none;
            color: #e74c3c;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-delete-row:hover {
            background: #e74c3c;
            color: #fff;
        }
        
        /* –ë–ª–æ–∫ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ */
        .responsible-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #aaa;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
            min-width: 140px;
        }
        
        .filter-group select option {
            background: #1a1a2e;
        }
        
        /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .settings-section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .settings-item button {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-weight: 500;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #f39c12;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤ */
        @media (max-width: 768px) {
            .main-screen {
                padding: 15px;
                padding-top: 70px;
            }
            
            .logo-container {
                top: 10px;
                left: 10px;
            }
            
            .logo {
                width: 40px;
                height: 40px;
            }
            
            .logo-text {
                display: none;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 1 –∏–∑ 3
     –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å: HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ (body)
     ============================================================ -->
<!-- ============================================================
     –ß–ê–°–¢–¨ 2 –∏–∑ 3: HTML-–†–ê–ó–ú–ï–¢–ö–ê (BODY)
     –°–æ–¥–µ—Ä–∂–∏—Ç: –ª–æ–≥–æ—Ç–∏–ø, —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞, –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω, –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
     –°—Ç—Ä–æ–∫–∏: 281-460
     ============================================================ -->
<body>
    <!-- –õ–æ–≥–æ—Ç–∏–ø –≤ —É–≥–ª—É -->
    <div class="logo-container" id="logoContainer">
        <div class="logo">‚ö°</div>
        <span class="logo-text">–†–ï–ú–û–ù–¢ –≠–î</span>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>‚ö° –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <p>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</p>
            <div class="input-group">
                <label>–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
        </div>
    </div>
    
    <!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù -->
    <div class="main-screen" id="mainScreen">
        <div class="header">
            <h1>‚ö° –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="showHistory()">üìã –ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="btn btn-secondary" id="settingsBtn" style="display:none;" onclick="showSettings()">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
            </div>
        </div>
        
        <div class="form-section">
            <h2>üìù –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ <span class="datetime" id="currentDateTime"></span></h2>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="col-num">‚Ññ</th>
                            <th class="col-dept">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                            <th class="col-loc">–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
                            <th class="col-motor">–≠–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª—å</th>
                            <th class="col-inv">–ò–Ω–≤. ‚Ññ</th>
                            <th class="col-manuf">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</th>
                            <th class="col-power">–∫–í—Ç</th>
                            <th class="col-speed">–û–±/–º–∏–Ω</th>
                            <th class="col-reason">–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ–º–æ–Ω—Ç–∞</th>
                            <th class="col-del"></th>
                        </tr>
                    </thead>
                    <tbody id="itemsTable"></tbody>
                </table>
            </div>
            
            <button class="btn btn-secondary btn-small" onclick="addRow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
            
            <div class="responsible-section">
                <div class="input-group">
                    <label>–§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ:</label>
                    <input type="text" id="responsible" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" maxlength="50">
                </div>
                <div class="input-group">
                    <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
                    <input type="text" id="phone" placeholder="+7 (999) 123-45-67" maxlength="20">
                </div>
            </div>
            
            <div class="form-buttons">
                <button class="btn btn-danger" onclick="clearForm()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="btn btn-success" onclick="submitForm()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ò–°–¢–û–†–ò–Ø -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h2>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-secondary btn-small modal-print" onclick="printHistory()">üñ® –ü–µ—á–∞—Ç—å</button>
                    <button class="modal-close" onclick="closeHistory()">&times;</button>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label>
                    <select id="filterDepartment"></select>
                </div>
                <div class="filter-group">
                    <label>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</label>
                    <select id="filterLocation"></select>
                </div>
                <div class="filter-group">
                    <label>–ú–æ—â–Ω–æ—Å—Ç—å:</label>
                    <select id="filterPower"></select>
                </div>
                <div class="filter-group">
                    <label>–ò–Ω–≤. –Ω–æ–º–µ—Ä:</label>
                    <input type="text" id="filterInvNumber" placeholder="–ü–æ–∏—Å–∫..." maxlength="5">
                </div>
                <button class="btn btn-primary btn-small" onclick="loadHistory()">üîç –ù–∞–π—Ç–∏</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>‚Ññ –∑–∞—è–≤–∫–∏</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                            <th>–ú–µ—Å—Ç–æ</th>
                            <th>–î–≤–∏–≥–∞—Ç–µ–ª—å</th>
                            <th>–ò–Ω–≤. ‚Ññ</th>
                            <th>–ü—Ä–æ–∏–∑–≤–æ–¥.</th>
                            <th>–∫–í—Ç</th>
                            <th>–û–±/–º–∏–Ω</th>
                            <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤</h2>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>üè≠ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</h3>
                    <div class="settings-list" id="departmentsList"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newDepartment" placeholder="–ù–æ–≤–æ–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" maxlength="30" style="flex:1; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.1); color:#fff;">
                        <button class="btn btn-success btn-small" onclick="addDepartment()">+</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>üìç –ú–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</h3>
                    <div class="settings-list" id="locationsList"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newLocation" placeholder="–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ" maxlength="30" style="flex:1; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.1); color:#fff;">
                        <button class="btn btn-success btn-small" onclick="addLocation()">+</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏</h3>
                    <div class="settings-list" id="manufacturersList"></div>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newManufacturer" placeholder="–ù–æ–≤—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å" maxlength="30" style="flex:1; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.1); color:#fff;">
                        <button class="btn btn-success btn-small" onclick="addManufacturer()">+</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-success" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            </div>
        </div>
    </div>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 2 –∏–∑ 3
     –°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å: JavaScript (–≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
     –í–ê–ñ–ù–û: –¢–µ–≥ </body> –∏ </html> –±—É–¥—É—Ç –≤ –∫–æ–Ω—Ü–µ –ß–∞—Å—Ç–∏ 3
     ============================================================ -->
<!-- ============================================================
     –ß–ê–°–¢–¨ 3 –∏–∑ 3: JAVASCRIPT (–í–ï–°–¨ –§–£–ù–ö–¶–ò–û–ù–ê–õ)
     –°–æ–¥–µ—Ä–∂–∏—Ç: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –±—É—Ñ–µ—Ä –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Ñ–æ—Ä–º—ã,
               –∏—Å—Ç–æ—Ä–∏—è, –ø–µ—á–∞—Ç—å, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
     –°—Ç—Ä–æ–∫–∏: 461-850
     ============================================================ -->
<script>
    // ============================================================
    // –ë–õ–û–ö 1: –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
    // ============================================================
    
    var API_URL = 'https://script.google.com/macros/s/AKfycbyOBekvdpYEJwE6GCF2Ceaxqo-jAfgJ5oyoxdFTsmEznQNe85qlATtu0lLlUdEJIGvN/exec';
    
    var currentPassword = '';
    var isAdmin = false;
    var settings = {
        departments: [],
        locations: [],
        powers: [],
        speeds: [],
        manufacturers: []
    };
    
    var MAX_LENGTH = 30;
    var INV_LENGTH = 5;
    var BUFFER_EXPIRY_HOURS = 24;

    // ============================================================
    // –ë–õ–û–ö 2: –°–ò–°–¢–ï–ú–ê –ë–£–§–ï–†–ê –î–ê–ù–ù–´–• (sessionStorage + —Ç–∞–π–º–µ—Ä 24—á)
    // ============================================================
    
    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤ –±—É—Ñ–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
     * –ë—É—Ñ–µ—Ä –∂–∏–≤—ë—Ç –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –ò–õ–ò 24 —á–∞—Å–∞ (—á—Ç–æ —Ä–∞–Ω—å—à–µ)
     */
    function saveToBuffer() {
        try {
            var formData = collectFormData();
            if (!formData) return false;
            
            var bufferData = {
                timestamp: new Date().toISOString(),
                responsible: formData.responsible,
                phone: formData.phone,
                items: formData.items
            };
            
            sessionStorage.setItem('pendingRequest', JSON.stringify(bufferData));
            return true;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä:', e);
            return false;
        }
    }
    
    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã (–±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π)
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ null –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –ø—É—Å—Ç–∞
     */
    function collectFormData() {
        var responsible = document.getElementById('responsible').value.trim();
        var phone = document.getElementById('phone').value.trim();
        
        var rows = document.querySelectorAll('#itemsTable tr');
        var items = [];
        
        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].cells;
            var item = {
                department: cells[1].querySelector('select').value,
                location: cells[2].querySelector('select').value,
                motor: cells[3].querySelector('input').value.trim(),
                invNumber: cells[4].querySelector('input').value.trim().toUpperCase(),
                manufacturer: cells[5].querySelector('select').value,
                power: cells[6].querySelector('select').value,
                speed: cells[7].querySelector('select').value,
                reason: cells[8].querySelector('input').value.trim()
            };
            items.push(item);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ
        var hasData = responsible || phone || items.some(function(item) {
            return item.motor || item.department || item.location;
        });
        
        if (!hasData) return null;
        
        return {
            responsible: responsible,
            phone: phone,
            items: items
        };
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –±—É—Ñ–µ—Ä–µ –∏ –∏—Ö –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ null
     */
    function getBufferData() {
        try {
            var stored = sessionStorage.getItem('pendingRequest');
            if (!stored) return null;
            
            var bufferData = JSON.parse(stored);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏ (24 —á–∞—Å–∞)
            var savedTime = new Date(bufferData.timestamp).getTime();
            var now = new Date().getTime();
            var hoursPassed = (now - savedTime) / (1000 * 60 * 60);
            
            if (hoursPassed > BUFFER_EXPIRY_HOURS) {
                clearBuffer();
                return null;
            }
            
            return bufferData;
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞:', e);
            return null;
        }
    }
    
    /**
     * –û—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä –¥–∞–Ω–Ω—ã—Ö
     */
    function clearBuffer() {
        try {
            sessionStorage.removeItem('pendingRequest');
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –±—É—Ñ–µ—Ä–∞:', e);
        }
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±—É—Ñ–µ—Ä –ø—Ä–∏ –≤—Ö–æ–¥–µ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
     */
    function checkAndRestoreBuffer() {
        var bufferData = getBufferData();
        
        if (!bufferData) return;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        var hasItems = bufferData.items && bufferData.items.some(function(item) {
            return item.motor || item.department;
        });
        var hasResponsible = bufferData.responsible || bufferData.phone;
        
        if (!hasItems && !hasResponsible) {
            clearBuffer();
            return;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        var savedTime = new Date(bufferData.timestamp);
        var timeStr = savedTime.toLocaleString('ru-RU');
        
        var confirmMsg = '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç ' + timeStr + '.\n\n' +
                         '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞—è–≤–∫—É?\n\n' +
                         '‚Ä¢ –û–ö - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ\n' +
                         '‚Ä¢ –û—Ç–º–µ–Ω–∞ - –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–π —Ñ–æ—Ä–º—ã';
        
        if (confirm(confirmMsg)) {
            restoreFromBuffer(bufferData);
            showNotification('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ –±—É—Ñ–µ—Ä–∞', 'success');
        } else {
            clearBuffer();
        }
    }
    
    /**
     * –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±—É—Ñ–µ—Ä–∞ –≤ —Ñ–æ—Ä–º—É
     */
    function restoreFromBuffer(bufferData) {
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é —Ç–∞–±–ª–∏—Ü—É
        document.getElementById('itemsTable').innerHTML = '';
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
        if (bufferData.items && bufferData.items.length > 0) {
            for (var i = 0; i < bufferData.items.length; i++) {
                addRow();
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            var rows = document.querySelectorAll('#itemsTable tr');
            for (var i = 0; i < rows.length && i < bufferData.items.length; i++) {
                var cells = rows[i].cells;
                var item = bufferData.items[i];
                
                cells[1].querySelector('select').value = item.department || '';
                cells[2].querySelector('select').value = item.location || '';
                cells[3].querySelector('input').value = item.motor || '';
                cells[4].querySelector('input').value = item.invNumber || '';
                cells[5].querySelector('select').value = item.manufacturer || '';
                cells[6].querySelector('select').value = item.power || '';
                cells[7].querySelector('select').value = item.speed || '';
                cells[8].querySelector('input').value = item.reason || '';
            }
        } else {
            addRow();
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
        document.getElementById('responsible').value = bufferData.responsible || '';
        document.getElementById('phone').value = bufferData.phone || '';
    }

    // ============================================================
    // –ë–õ–û–ö 3: –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –î–ê–¢–´ –ò –í–†–ï–ú–ï–ù–ò
    // ============================================================
    
    var bangkokFormatter;
    try {
        bangkokFormatter = new Intl.DateTimeFormat('ru-RU', {
            timeZone: 'Asia/Bangkok',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        bangkokFormatter = new Intl.DateTimeFormat('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function formatToBangkok(dateInput) {
        if (!dateInput && dateInput !== 0) return '';
        var d = (dateInput instanceof Date) ? dateInput : new Date(dateInput);
        if (isNaN(d.getTime())) return dateInput || '';
        return bangkokFormatter.format(d);
    }
    
    function updateDateTime() {
        document.getElementById('currentDateTime').textContent = formatToBangkok(new Date());
    }

    // ============================================================
    // –ë–õ–û–ö 4: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ì–†–£–ó–ö–ê
    // ============================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });
        updateDateTime();
        setInterval(updateDateTime, 60000);
    });
    
    function showLoading() {
        document.getElementById('loading').style.display = 'flex';
    }
    
    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    // ============================================================
    // –ë–õ–û–ö 5: –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    // ============================================================
    
    function showNotification(message, type) {
        var existing = document.querySelector('.notification');
        if (existing) existing.remove();
        
        var div = document.createElement('div');
        div.className = 'notification ' + type;
        div.textContent = message;
        document.body.appendChild(div);
        
        var duration = (type === 'warning') ? 8000 : 4000;
        setTimeout(function() { div.remove(); }, duration);
    }

    // ============================================================
    // –ë–õ–û–ö 6: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–í–•–û–î/–í–´–•–û–î)
    // ============================================================
    
    function login() {
        var password = document.getElementById('password').value.trim();
        
        if (!password) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'error');
            return;
        }
        
        showLoading();
        
        var url = API_URL + '?action=getSettings&password=' + encodeURIComponent(password);
        
        fetch(url)
            .then(function(response) { return response.json(); })
            .then(function(result) {
                hideLoading();
                
                if (!result.success) {
                    showNotification(result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'error');
                    return;
                }
                
                currentPassword = password;
                isAdmin = result.isAdmin || false;
                settings = {
                    departments: result.departments || [],
                    locations: result.locations || [],
                    powers: result.powers || [],
                    speeds: result.speeds || [],
                    manufacturers: result.manufacturers || []
                };
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                document.getElementById('logoContainer').style.display = 'flex';
                
                if (isAdmin) {
                    document.getElementById('settingsBtn').style.display = 'inline-flex';
                }
                
                initForm();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—É—Ñ–µ—Ä –ü–û–°–õ–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
                checkAndRestoreBuffer();
                
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
            })
            .catch(function(error) {
                hideLoading();
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
            });
    }
    
    function logout() {
        currentPassword = '';
        isAdmin = false;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainScreen').style.display = 'none';
        document.getElementById('logoContainer').style.display = 'none';
        document.getElementById('settingsBtn').style.display = 'none';
        document.getElementById('password').value = '';
    }

    // ============================================================
    // –ë–õ–û–ö 7: –†–ê–ë–û–¢–ê –° –§–û–†–ú–û–ô (–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø, –°–¢–†–û–ö–ò, –û–ß–ò–°–¢–ö–ê)
    // ============================================================
    
    function initForm() {
        document.getElementById('itemsTable').innerHTML = '';
        addRow();
        document.getElementById('responsible').value = '';
        document.getElementById('phone').value = '';
    }
    
    function createSelect(options, placeholder) {
        var html = '<select><option value="">' + placeholder + '</option>';
        for (var i = 0; i < options.length; i++) {
            html += '<option value="' + options[i] + '">' + options[i] + '</option>';
        }
        html += '</select>';
        return html;
    }
    
    function addRow() {
        var tbody = document.getElementById('itemsTable');
        var rowNum = tbody.children.length + 1;
        
        var tr = document.createElement('tr');
        tr.innerHTML = 
            '<td class="col-num">' + rowNum + '</td>' +
            '<td class="col-dept">' + createSelect(settings.departments, '–í—ã–±–µ—Ä–∏—Ç–µ...') + '</td>' +
            '<td class="col-loc">' + createSelect(settings.locations, '–í—ã–±–µ—Ä–∏—Ç–µ...') + '</td>' +
            '<td class="col-motor"><input type="text" placeholder="–ú–∞—Ä–∫–∞" maxlength="' + MAX_LENGTH + '"></td>' +
            '<td class="col-inv"><input type="text" placeholder="00000" maxlength="' + INV_LENGTH + '" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z–ê-–Ø0-9]/g,\'\')"></td>' +
            '<td class="col-manuf">' + createSelect(settings.manufacturers, '–í—ã–±–µ—Ä–∏—Ç–µ...') + '</td>' +
            '<td class="col-power">' + createSelect(settings.powers, '–∫–í—Ç') + '</td>' +
            '<td class="col-speed">' + createSelect(settings.speeds, '–û–±/–º–∏–Ω') + '</td>' +
            '<td class="col-reason"><input type="text" placeholder="–ü—Ä–∏—á–∏–Ω–∞" maxlength="' + MAX_LENGTH + '"></td>' +
            '<td class="col-del"><button class="btn-delete-row" onclick="deleteRow(this)">√ó</button></td>';
        tbody.appendChild(tr);
    }
    
    function deleteRow(btn) {
        var tbody = document.getElementById('itemsTable');
        if (tbody.children.length <= 1) {
            showNotification('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞', 'error');
            return;
        }
        btn.closest('tr').remove();
        renumberRows();
    }
    
    function renumberRows() {
        var rows = document.querySelectorAll('#itemsTable tr');
        for (var i = 0; i < rows.length; i++) {
            rows[i].cells[0].textContent = i + 1;
        }
    }
    
    function clearForm() {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã –∏ –±—É—Ñ–µ—Ä –¥–∞–Ω–Ω—ã—Ö?')) {
            clearBuffer();
            initForm();
            showNotification('–§–æ—Ä–º–∞ –∏ –±—É—Ñ–µ—Ä –æ—á–∏—â–µ–Ω—ã', 'success');
        }
    }

    // ============================================================
    // –ë–õ–û–ö 8: –û–¢–ü–†–ê–í–ö–ê –ó–ê–Ø–í–ö–ò (–° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –í –ë–£–§–ï–†)
    // ============================================================
    
    function submitForm() {
        var responsible = document.getElementById('responsible').value.trim();
        var phone = document.getElementById('phone').value.trim();
        
        if (!responsible) {
            showNotification('–£–∫–∞–∂–∏—Ç–µ –§–ò–û –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ', 'error');
            return;
        }
        
        if (!phone) {
            showNotification('–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω', 'error');
            return;
        }
        
        var rows = document.querySelectorAll('#itemsTable tr');
        var items = [];
        
        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].cells;
            var motor = cells[3].querySelector('input').value.trim();
            
            if (!motor) continue;
            
            var department = cells[1].querySelector('select').value;
            var location = cells[2].querySelector('select').value;
            var invNumber = cells[4].querySelector('input').value.trim().toUpperCase();
            var manufacturer = cells[5].querySelector('select').value;
            var power = cells[6].querySelector('select').value;
            var speed = cells[7].querySelector('select').value;
            var reason = cells[8].querySelector('input').value.trim();
            
            if (!department) { showNotification('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ', 'error'); return; }
            if (!location) { showNotification('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ', 'error'); return; }
            if (!manufacturer) { showNotification('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è', 'error'); return; }
            if (!power) { showNotification('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ—â–Ω–æ—Å—Ç—å', 'error'); return; }
            if (!speed) { showNotification('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±–æ—Ä–æ—Ç—ã', 'error'); return; }
            
            items.push({
                department: department,
                location: location,
                motor: motor,
                invNumber: invNumber,
                manufacturer: manufacturer,
                power: power,
                speed: speed,
                reason: reason
            });
        }
        
        if (items.length === 0) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –¥–≤–∏–≥–∞—Ç–µ–ª—è', 'error');
            return;
        }
        
        // –°–û–•–†–ê–ù–Ø–ï–ú –í –ë–£–§–ï–† –ü–ï–†–ï–î –û–¢–ü–†–ê–í–ö–û–ô
        saveToBuffer();
        
        showLoading();
        
        var data = {
            responsible: responsible,
            phone: phone,
            items: items
        };
        
        var url = API_URL + '?action=submit&password=' + encodeURIComponent(currentPassword) + '&data=' + encodeURIComponent(JSON.stringify(data));
        
        fetch(url)
            .then(function(response) { return response.json(); })
            .then(function(result) {
                hideLoading();
                if (result.success) {
                    // –£–°–ü–ï–•: –æ—á–∏—â–∞–µ–º –±—É—Ñ–µ—Ä –∏ —Ñ–æ—Ä–º—É
                    clearBuffer();
                    showNotification('‚úì –ó–∞—è–≤–∫–∞ ' + result.applicationNumber + ' —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞! –ó–∞–ø–∏—Å–µ–π: ' + result.count, 'success');
                    initForm();
                } else {
                    // –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: –±—É—Ñ–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω, —Ñ–æ—Ä–º–∞ –ù–ï –æ—á–∏—â–∞–µ—Ç—Å—è
                    showNotification('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            })
            .catch(function(error) {
                hideLoading();
                // –û–®–ò–ë–ö–ê –°–ï–¢–ò/–¢–ê–ô–ú–ê–£–¢: –±—É—Ñ–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω, —Ñ–æ—Ä–º–∞ –ù–ï –æ—á–∏—â–∞–µ—Ç—Å—è
                showNotification('‚ö† –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ò—Å—Ç–æ—Ä–∏—é. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.', 'warning');
            });
    }

    // ============================================================
    // –ë–õ–û–ö 9: –ò–°–¢–û–†–ò–Ø –ó–ê–Ø–í–û–ö
    // ============================================================
    
    function showHistory() {
        document.getElementById('historyModal').style.display = 'flex';
        fillFilter('filterDepartment', settings.departments, '–í—Å–µ');
        fillFilter('filterLocation', settings.locations, '–í—Å–µ');
        fillFilter('filterPower', settings.powers, '–õ—é–±–∞—è');
        loadHistory();
    }
    
    function closeHistory() {
        document.getElementById('historyModal').style.display = 'none';
    }
    
    function fillFilter(id, options, placeholder) {
        var select = document.getElementById(id);
        select.innerHTML = '<option value="">' + placeholder + '</option>';
        for (var i = 0; i < options.length; i++) {
            select.innerHTML += '<option value="' + options[i] + '">' + options[i] + '</option>';
        }
    }
    
    function loadHistory() {
        var department = document.getElementById('filterDepartment').value;
        var location = document.getElementById('filterLocation').value;
        var power = document.getElementById('filterPower').value;
        var invNumber = document.getElementById('filterInvNumber').value.trim();
        
        showLoading();
        
        var url = API_URL + '?action=getHistory&password=' + encodeURIComponent(currentPassword);
        if (department) url += '&department=' + encodeURIComponent(department);
        if (location) url += '&location=' + encodeURIComponent(location);
        if (power) url += '&power=' + encodeURIComponent(power);
        if (invNumber) url += '&invNumber=' + encodeURIComponent(invNumber);
        
        fetch(url)
            .then(function(response) { return response.json(); })
            .then(function(result) {
                hideLoading();
                if (result.success) {
                    renderHistory(result.data);
                } else {
                    showNotification(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                }
            })
            .catch(function(error) {
                hideLoading();
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            });
    }
    
    function renderHistory(data) {
        var tbody = document.getElementById('historyTable');
        
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:30px; color:#888;">–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            return;
        }
        
        var html = '';
        for (var i = 0; i < data.length; i++) {
            var r = data[i];
            var dateFormatted = r.date ? formatToBangkok(r.date) : '';
            html += '<tr>' +
                '<td>' + (r.number || '') + '</td>' +
                '<td>' + dateFormatted + '</td>' +
                '<td>' + (r.department || '') + '</td>' +
                '<td>' + (r.location || '') + '</td>' +
                '<td>' + (r.motor || '') + '</td>' +
                '<td>' + (r.invNumber || '') + '</td>' +
                '<td>' + (r.manufacturer || '') + '</td>' +
                '<td>' + (r.power || '') + '</td>' +
                '<td>' + (r.speed || '') + '</td>' +
                '<td>' + (r.reason || '') + '</td>' +
                '<td>' + (r.responsible || '') + '</td>' +
                '<td>' + (r.phone || '') + '</td>' +
                '</tr>';
        }
        tbody.innerHTML = html;
    }

    // ============================================================
    // –ë–õ–û–ö 10: –ü–ï–ß–ê–¢–¨ –ò–°–¢–û–†–ò–ò
    // ============================================================
    
    function printHistory() {
        var department = document.getElementById('filterDepartment').value;
        var location = document.getElementById('filterLocation').value;
        var power = document.getElementById('filterPower').value;
        var invNumber = document.getElementById('filterInvNumber').value.trim();

        var filtersHtml = '<div style="margin-bottom:12px; font-size:14px;">';
        if (department) filtersHtml += '<strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong> ' + escapeHtml(department) + ' &nbsp; ';
        if (location) filtersHtml += '<strong>–ú–µ—Å—Ç–æ:</strong> ' + escapeHtml(location) + ' &nbsp; ';
        if (power) filtersHtml += '<strong>–ú–æ—â–Ω–æ—Å—Ç—å:</strong> ' + escapeHtml(power) + ' &nbsp; ';
        if (invNumber) filtersHtml += '<strong>–ò–Ω–≤. ‚Ññ:</strong> ' + escapeHtml(invNumber) + ' &nbsp; ';
        if (filtersHtml === '<div style="margin-bottom:12px; font-size:14px;">') filtersHtml += '<em>–§–∏–ª—å—Ç—Ä—ã: –≤—Å–µ</em>';
        filtersHtml += '</div>';

        var table = document.querySelector('#historyModal .table-container table');
        if (!table) {
            showNotification('–¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            return;
        }

        var tableHtml = table.outerHTML;
        var title = '–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫';
        var generatedAt = formatToBangkok(new Date());
        
        var printStyles = 'body{font-family:Arial,sans-serif;color:#000;background:#fff;padding:20px;}' +
            'h1{font-size:18px;margin-bottom:6px;}' +
            'p.meta{font-size:13px;color:#333;margin-bottom:6px;}' +
            'table{width:100%;border-collapse:collapse;font-size:12px;}' +
            'th,td{border:1px solid #444;padding:6px 8px;text-align:left;}' +
            'thead th{background:#eee;}';

        var html = '<!doctype html><html><head><meta charset="utf-8"><title>' + escapeHtml(title) + '</title><style>' + printStyles + '</style></head><body>' +
            '<h1>' + escapeHtml(title) + '</h1>' +
            '<p class="meta">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ: ' + escapeHtml(generatedAt) + '</p>' +
            filtersHtml + tableHtml + '</body></html>';

        var printWindow = window.open('', '_blank');
        if (!printWindow) {
            showNotification('–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ', 'error');
            return;
        }
        printWindow.document.open();
        printWindow.document.write(html);
        printWindow.document.close();

        setTimeout(function() {
            printWindow.focus();
            printWindow.print();
        }, 500);
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    // ============================================================
    // –ë–õ–û–ö 11: –ù–ê–°–¢–†–û–ô–ö–ò –°–ü–†–ê–í–û–ß–ù–ò–ö–û–í (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê)
    // ============================================================
    
    function showSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        renderSettingsList('departmentsList', settings.departments);
        renderSettingsList('locationsList', settings.locations);
        renderSettingsList('manufacturersList', settings.manufacturers);
    }
    
    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }
    
    function renderSettingsList(containerId, items) {
        var container = document.getElementById(containerId);
        var html = '';
        for (var i = 0; i < items.length; i++) {
            var item = items[i];
            var escaped = item.replace(/'/g, "\\'");
            html += '<div class="settings-item"><span>' + item + '</span><button onclick="removeItem(\'' + containerId + '\',\'' + escaped + '\')">√ó</button></div>';
        }
        container.innerHTML = html;
    }
    
    function removeItem(containerId, item) {
        if (containerId === 'departmentsList') {
            settings.departments = settings.departments.filter(function(d) { return d !== item; });
            renderSettingsList(containerId, settings.departments);
        } else if (containerId === 'locationsList') {
            settings.locations = settings.locations.filter(function(l) { return l !== item; });
            renderSettingsList(containerId, settings.locations);
        } else if (containerId === 'manufacturersList') {
            settings.manufacturers = settings.manufacturers.filter(function(m) { return m !== item; });
            renderSettingsList(containerId, settings.manufacturers);
        }
    }
    
    function addDepartment() {
        var input = document.getElementById('newDepartment');
        var value = input.value.trim();
        if (value && settings.departments.indexOf(value) === -1) {
            settings.departments.push(value);
            renderSettingsList('departmentsList', settings.departments);
            input.value = '';
        }
    }
    
    function addLocation() {
        var input = document.getElementById('newLocation');
        var value = input.value.trim();
        if (value && settings.locations.indexOf(value) === -1) {
            settings.locations.push(value);
            renderSettingsList('locationsList', settings.locations);
            input.value = '';
        }
    }
    
    function addManufacturer() {
        var input = document.getElementById('newManufacturer');
        var value = input.value.trim();
        if (value && settings.manufacturers.indexOf(value) === -1) {
            settings.manufacturers.push(value);
            renderSettingsList('manufacturersList', settings.manufacturers);
            input.value = '';
        }
    }
    
    function saveSettings() {
        showLoading();
        
        var saved = 0;
        var total = 3;
        
        function checkDone() {
            saved++;
            if (saved >= total) {
                hideLoading();
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
                closeSettings();
            }
        }
        
        var url1 = API_URL + '?action=updateList&password=' + encodeURIComponent(currentPassword) + '&listType=departments&items=' + encodeURIComponent(JSON.stringify(settings.departments));
        fetch(url1).then(checkDone).catch(checkDone);
        
        var url2 = API_URL + '?action=updateList&password=' + encodeURIComponent(currentPassword) + '&listType=locations&items=' + encodeURIComponent(JSON.stringify(settings.locations));
        fetch(url2).then(checkDone).catch(checkDone);
        
        var url3 = API_URL + '?action=updateList&password=' + encodeURIComponent(currentPassword) + '&listType=manufacturers&items=' + encodeURIComponent(JSON.stringify(settings.manufacturers));
        fetch(url3).then(checkDone).catch(checkDone);
    }
</script>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 3 –∏–∑ 3
     ============================================================ -->
</body>
</html>
