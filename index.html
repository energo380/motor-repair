<!-- ============================================================
     –§–ê–ô–õ: index.html
     –ß–ê–°–¢–¨ 1 –∏–∑ 5: DOCTYPE, HEAD, CSS-–°–¢–ò–õ–ò
     ============================================================ -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .logo-container {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
        
        .logo-text {
            font-size: 14px;
            font-weight: bold;
            color: #f39c12;
        }
        
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .login-box h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .login-box p {
            text-align: center;
            color: #aaa;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #f39c12;
        }
        
        .input-group input::placeholder {
            color: #888;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
            color: #fff;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: #fff;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal-print {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .main-screen {
            display: none;
            padding: 20px;
            padding-left: 80px;
            padding-top: 80px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-buttons {
            display: flex;
            gap: 10px;
        }
        
        .form-section {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .form-section h2 {
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .datetime {
            font-size: 14px;
            color: #aaa;
            font-weight: normal;
            margin-left: auto;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1100px;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }
        
        td select,
        td input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
        }
        
        td select:focus,
        td input:focus {
            outline: none;
            border-color: #f39c12;
        }
        
        td select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .col-num { width: 40px; text-align: center; }
        .col-dept { width: 150px; }
        .col-loc { width: 130px; }
        .col-motor { width: 120px; }
        .col-inv { width: 80px; }
        .col-manuf { width: 100px; }
        .col-power { width: 70px; }
        .col-speed { width: 80px; }
        .col-reason { width: 130px; }
        .col-del { width: 40px; }
        
        .btn-delete-row {
            background: rgba(231, 76, 60, 0.2);
            border: none;
            color: #e74c3c;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-delete-row:hover {
            background: #e74c3c;
            color: #fff;
        }
        
        .responsible-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            opacity: 0.7;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #aaa;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
            min-width: 140px;
        }
        
        .filter-group select option {
            background: #1a1a2e;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .settings-section {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .settings-item button {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 16px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: #fff;
            font-weight: 500;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 4000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #f39c12;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-screen {
                padding: 15px;
                padding-top: 70px;
            }
            .logo-container {
                top: 10px;
                left: 10px;
            }
            .logo {
                width: 40px;
                height: 40px;
            }
            .logo-text {
                display: none;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 1 –∏–∑ 5 ‚Äî CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
     ============================================================ -->
<!-- ============================================================
     –§–ê–ô–õ: index.html
     –ß–ê–°–¢–¨ 2 –∏–∑ 5: HTML-–†–ê–ó–ú–ï–¢–ö–ê BODY
     ============================================================ -->
<body>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <div class="logo-container" id="logoContainer">
        <div class="logo">‚ö°</div>
        <span class="logo-text">–†–ï–ú–û–ù–¢</span>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>‚ö° –≠–ª–µ–∫—Ç—Ä–æ—Ü–µ—Ö</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</p>
            <div class="input-group">
                <label>–ü–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞:</label>
                <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" onkeypress="if(event.key==='Enter')login()">
            </div>
            <button class="btn btn-primary" onclick="login()">üîë –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
    <div class="main-screen" id="mainScreen">
        <div class="header">
            <h1>üìã –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫</h1>
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="openHistory()">üìÇ –ò—Å—Ç–æ—Ä–∏—è</button>
                <button class="btn btn-secondary" id="btnSettings" style="display:none" onclick="openSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ –í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <div class="form-section">
            <h2>
                üîß –î–∞–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–µ–π
                <span class="datetime" id="currentDateTime"></span>
            </h2>

            <div class="table-container">
                <table id="motorsTable">
                    <thead>
                        <tr>
                            <th class="col-num">‚Ññ</th>
                            <th class="col-dept">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th>
                            <th class="col-loc">–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</th>
                            <th class="col-motor">–î–≤–∏–≥–∞—Ç–µ–ª—å</th>
                            <th class="col-inv">–ò–Ω–≤. ‚Ññ</th>
                            <th class="col-manuf">–ü—Ä–æ–∏–∑–≤–æ–¥.</th>
                            <th class="col-power">–∫–í—Ç</th>
                            <th class="col-speed">–û–±/–º–∏–Ω</th>
                            <th class="col-reason">–ü—Ä–∏—á–∏–Ω–∞</th>
                            <th class="col-del"></th>
                        </tr>
                    </thead>
                    <tbody id="motorsBody">
                    </tbody>
                </table>
            </div>

            <button class="btn btn-secondary btn-small" onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—å</button>

            <div class="responsible-section">
                <div class="input-group">
                    <label>üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π (–§–ò–û):</label>
                    <input type="text" id="responsible" maxlength="100" placeholder="–§–∞–º–∏–ª–∏—è –ò.–û.">
                </div>
                <div class="input-group">
                    <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</label>
                    <input type="text" id="phone" maxlength="20" placeholder="+7 (___) ___-__-__">
                </div>
            </div>

            <div class="form-buttons">
                <button class="btn btn-success" onclick="submitAll()">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫–∏</button>
                <button class="btn btn-secondary" onclick="clearForm()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width:1400px">
            <div class="modal-header">
                <h2>üìÇ –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h2>
                <div>
                    <button class="btn btn-secondary btn-small modal-print" onclick="printHistory()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                    <button class="modal-close" onclick="closeHistory()">‚úï</button>
                </div>
            </div>
            <div class="filters" id="historyFilters"></div>
            <div class="table-container" id="historyTableContainer"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="settings-grid" id="settingsGrid"></div>
            <div style="margin-top:20px;text-align:right">
                <button class="btn btn-success" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
            </div>
        </div>
    </div>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 2 –∏–∑ 5 ‚Äî HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
     ============================================================ -->
<!-- ============================================================
     –§–ê–ô–õ: index.html
     –ß–ê–°–¢–¨ 3 –∏–∑ 5: JAVASCRIPT ‚Äî –ù–ê–ß–ê–õ–û
     ============================================================ -->
<script>
var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVWpFRNmKiPvPMsBMz55oVLTbJJxnVCxBxqmoTc2bWSU1aqiuaXPYNiJThZIMgE4bt/exec';

var settings = {};
var userRole = '';
var rowCounter = 0;

function showLoading() {
    document.getElementById('loading').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function notify(message, type) {
    var div = document.createElement('div');
    div.className = 'notification ' + type;
    div.textContent = message;
    document.body.appendChild(div);
    setTimeout(function() { div.remove(); }, 4000);
}

function updateDateTime() {
    var now = new Date();
    var s = now.toLocaleDateString('ru-RU') + ' ' + now.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
    var el = document.getElementById('currentDateTime');
    if (el) el.textContent = s;
}

setInterval(updateDateTime, 60000);
updateDateTime();

function login() {
    var pw = document.getElementById('passwordInput').value;
    if (!pw) {
        notify('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', 'warning');
        return;
    }
    showLoading();
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action:'checkPassword', password: pw})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        hideLoading();
        if (data.success) {
            userRole = data.role;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('logoContainer').style.display = 'flex';
            if (userRole === 'admin') {
                document.getElementById('btnSettings').style.display = 'inline-flex';
            }
            loadSettings();
        } else {
            notify(data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
        }
    })
    .catch(function(err) {
        hideLoading();
        notify('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', 'error');
    });
}

function logout() {
    userRole = '';
    document.getElementById('mainScreen').style.display = 'none';
    document.getElementById('logoContainer').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('passwordInput').value = '';
}

function loadSettings() {
    showLoading();
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action:'getSettings'})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        hideLoading();
        if (data.success) {
            settings = data;
            if (document.querySelectorAll('#motorsBody tr').length === 0) {
                addRow();
            }
        } else {
            notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        }
    })
    .catch(function(err) {
        hideLoading();
        notify('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', 'error');
    });
}

function createSelect(options, name, className, selectedVal, isLocations) {
    var html = '<select name="' + name + '" class="' + className + '">';
    html += '<option value="">-- –≤—ã–±–æ—Ä --</option>';
    for (var i = 0; i < options.length; i++) {
        var optVal = '';
        var optLabel = '';
        if (isLocations && typeof options[i] === 'object') {
            optVal = options[i].name;
            optLabel = options[i].name;
        } else {
            optVal = options[i];
            optLabel = options[i];
        }
        var sel = (selectedVal && optVal == selectedVal) ? ' selected' : '';
        html += '<option value="' + optVal + '"' + sel + '>' + optLabel + '</option>';
    }
    html += '</select>';
    return html;
}

function getFilteredLocations(department) {
    if (!settings.locations) return [];
    if (!department) return settings.locations;
    var result = [];
    for (var i = 0; i < settings.locations.length; i++) {
        var loc = settings.locations[i];
        if (typeof loc === 'object') {
            if (!loc.department || loc.department === department) {
                result.push(loc);
            }
        } else {
            result.push(loc);
        }
    }
    return result;
}

function onDepartmentChange(selectEl) {
    var row = selectEl.closest('tr');
    if (!row) return;
    var locSelect = row.querySelector('select[name="location"]');
    if (!locSelect) return;
    var dept = selectEl.value;
    var locs = getFilteredLocations(dept);
    var html = '<option value="">-- –≤—ã–±–æ—Ä --</option>';
    for (var i = 0; i < locs.length; i++) {
        var locName = '';
        if (typeof locs[i] === 'object') {
            locName = locs[i].name;
        } else {
            locName = locs[i];
        }
        html += '<option value="' + locName + '">' + locName + '</option>';
    }
    locSelect.innerHTML = html;
}

function addRow() {
    rowCounter++;
    var tbody = document.getElementById('motorsBody');
    var tr = document.createElement('tr');
    tr.id = 'row_' + rowCounter;
    var num = tbody.children.length + 1;

    var deptSelect = createSelect(settings.departments || [], 'department', 'col-dept', '', false);
    var locSelect = createSelect(settings.locations || [], 'location', 'col-loc', '', true);
    var motorSelect = createSelect(settings.motors || [], 'motor', 'col-motor', '', false);
    var manufSelect = createSelect(settings.manufacturers || [], 'manufacturer', 'col-manuf', '', false);
    var powerSelect = createSelect(settings.powers || [], 'power', 'col-power', '', false);
    var speedSelect = createSelect(settings.speeds || [], 'speed', 'col-speed', '', false);
    var reasonSelect = createSelect(settings.reasons || [], 'reason', 'col-reason', '', false);

    tr.innerHTML =
        '<td class="col-num">' + num + '</td>' +
        '<td>' + deptSelect.replace('<select ', '<select onchange="onDepartmentChange(this)" ') + '</td>' +
        '<td>' + locSelect + '</td>' +
        '<td>' + motorSelect + '</td>' +
        '<td><input type="text" name="invNumber" maxlength="50" placeholder="–ò–Ω–≤.‚Ññ"></td>' +
        '<td>' + manufSelect + '</td>' +
        '<td>' + powerSelect + '</td>' +
        '<td>' + speedSelect + '</td>' +
        '<td>' + reasonSelect + '</td>' +
        '<td><button class="btn-delete-row" onclick="deleteRow(this)">‚úï</button></td>';

    tbody.appendChild(tr);
}

function deleteRow(btn) {
    var tbody = document.getElementById('motorsBody');
    if (tbody.children.length <= 1) {
        notify('–î–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞', 'warning');
        return;
    }
    btn.closest('tr').remove();
    renumberRows();
}

function renumberRows() {
    var rows = document.querySelectorAll('#motorsBody tr');
    for (var i = 0; i < rows.length; i++) {
        rows[i].querySelector('.col-num').textContent = i + 1;
    }
}

function clearForm() {
    document.getElementById('motorsBody').innerHTML = '';
    document.getElementById('responsible').value = '';
    document.getElementById('phone').value = '';
    rowCounter = 0;
    addRow();
}
</script>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 3 –∏–∑ 5
     ============================================================ -->
<!-- ============================================================
     –§–ê–ô–õ: index.html
     –ß–ê–°–¢–¨ 4 –∏–∑ 5: JAVASCRIPT ‚Äî –û–¢–ü–†–ê–í–ö–ê, –ò–°–¢–û–†–ò–Ø, –ü–ï–ß–ê–¢–¨
     ============================================================ -->
<script>
function submitAll() {
    var rows = document.querySelectorAll('#motorsBody tr');
    var responsible = document.getElementById('responsible').value.trim();
    var phone = document.getElementById('phone').value.trim();

    if (!responsible) {
        notify('–£–∫–∞–∂–∏—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ', 'warning');
        return;
    }

    var items = [];
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var item = {
            department: row.querySelector('select[name="department"]').value,
            location: row.querySelector('select[name="location"]').value,
            motor: row.querySelector('select[name="motor"]').value,
            invNumber: row.querySelector('input[name="invNumber"]').value.trim(),
            manufacturer: row.querySelector('select[name="manufacturer"]').value,
            power: row.querySelector('select[name="power"]').value,
            speed: row.querySelector('select[name="speed"]').value,
            reason: row.querySelector('select[name="reason"]').value,
            responsible: responsible,
            phone: phone
        };

        if (!item.department) {
            notify('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ', 'warning');
            return;
        }
        if (!item.motor) {
            notify('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–≥–∞—Ç–µ–ª—å', 'warning');
            return;
        }
        if (!item.reason) {
            notify('–°—Ç—Ä–æ–∫–∞ ' + (i+1) + ': –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É', 'warning');
            return;
        }
        items.push(item);
    }

    if (items.length === 0) {
        notify('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'warning');
        return;
    }

    showLoading();
    var sent = 0;
    var errors = [];
    var results = [];

    for (var j = 0; j < items.length; j++) {
        (function(index) {
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({action:'submit', item: items[index]})
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sent++;
                if (data.success) {
                    results.push('–ó–∞—è–≤–∫–∞ ' + data.number + ' —Å–æ–∑–¥–∞–Ω–∞');
                } else {
                    errors.push('–°—Ç—Ä–æ–∫–∞ ' + (index+1) + ': ' + data.error);
                }
                if (sent === items.length) {
                    hideLoading();
                    if (errors.length === 0) {
                        notify('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞—è–≤–æ–∫: ' + results.length, 'success');
                        clearForm();
                    } else {
                        notify('–û—à–∏–±–∫–∏: ' + errors.join('; '), 'error');
                    }
                }
            })
            .catch(function(err) {
                sent++;
                errors.push('–°—Ç—Ä–æ–∫–∞ ' + (index+1) + ': –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏');
                if (sent === items.length) {
                    hideLoading();
                    notify('–û—à–∏–±–∫–∏: ' + errors.join('; '), 'error');
                }
            });
        })(j);
    }
}

function openHistory() {
    document.getElementById('historyModal').style.display = 'flex';
    renderHistoryFilters();
    loadHistory();
}

function closeHistory() {
    document.getElementById('historyModal').style.display = 'none';
}

function renderHistoryFilters() {
    var container = document.getElementById('historyFilters');

    var deptOptions = '<option value="">–í—Å–µ</option>';
    if (settings.departments) {
        for (var i = 0; i < settings.departments.length; i++) {
            deptOptions += '<option value="' + settings.departments[i] + '">' + settings.departments[i] + '</option>';
        }
    }

    var locOptions = '<option value="">–í—Å–µ</option>';
    if (settings.locations) {
        for (var i = 0; i < settings.locations.length; i++) {
            var locName = '';
            if (typeof settings.locations[i] === 'object') {
                locName = settings.locations[i].name;
            } else {
                locName = settings.locations[i];
            }
            locOptions += '<option value="' + locName + '">' + locName + '</option>';
        }
    }

    var powerOptions = '<option value="">–õ—é–±–∞—è</option>';
    if (settings.powers) {
        for (var i = 0; i < settings.powers.length; i++) {
            powerOptions += '<option value="' + settings.powers[i] + '">' + settings.powers[i] + '</option>';
        }
    }

    container.innerHTML =
        '<div class="filter-group"><label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</label><select id="filterDept">' + deptOptions + '</select></div>' +
        '<div class="filter-group"><label>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:</label><select id="filterLoc">' + locOptions + '</select></div>' +
        '<div class="filter-group"><label>–ú–æ—â–Ω–æ—Å—Ç—å:</label><select id="filterPower">' + powerOptions + '</select></div>' +
        '<div class="filter-group"><label>–ò–Ω–≤. –Ω–æ–º–µ—Ä:</label><input id="filterInv" placeholder="–ü–æ–∏—Å–∫..."></div>' +
        '<div class="filter-group"><label>–î–∞—Ç–∞ —Å:</label><input type="date" id="filterDateFrom"></div>' +
        '<div class="filter-group"><label>–î–∞—Ç–∞ –ø–æ:</label><input type="date" id="filterDateTo"></div>' +
        '<button class="btn btn-primary btn-small" onclick="loadHistory()">üîç –ù–∞–π—Ç–∏</button>';
}

function loadHistory() {
    var params = {
        action: 'getHistory',
        department: document.getElementById('filterDept') ? document.getElementById('filterDept').value : '',
        location: document.getElementById('filterLoc') ? document.getElementById('filterLoc').value : '',
        power: document.getElementById('filterPower') ? document.getElementById('filterPower').value : '',
        invNumber: document.getElementById('filterInv') ? document.getElementById('filterInv').value : '',
        dateFrom: document.getElementById('filterDateFrom') ? document.getElementById('filterDateFrom').value : '',
        dateTo: document.getElementById('filterDateTo') ? document.getElementById('filterDateTo').value : ''
    };

    showLoading();
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(params)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        hideLoading();
        if (data.success) {
            renderHistory(data.data);
        } else {
            notify('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    })
    .catch(function(err) {
        hideLoading();
        notify('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', 'error');
    });
}

function renderHistory(records) {
    var container = document.getElementById('historyTableContainer');
    if (!records || records.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#aaa;padding:40px;">–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        return;
    }

    var html = '<table><thead><tr>';
    html += '<th>‚Ññ –∑–∞—è–≤–∫–∏</th><th>–î–∞—Ç–∞</th><th>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ</th>';
    html += '<th>–î–≤–∏–≥–∞—Ç–µ–ª—å</th><th>–ò–Ω–≤. ‚Ññ</th><th>–ü—Ä–æ–∏–∑–≤–æ–¥.</th><th>–∫–í—Ç</th>';
    html += '<th>–û–±/–º–∏–Ω</th><th>–ü—Ä–∏—á–∏–Ω–∞</th><th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th>';
    html += '</tr></thead><tbody>';

    for (var i = 0; i < records.length; i++) {
        var r = records[i];
        html += '<tr>';
        html += '<td>' + (r.number || '') + '</td>';
        html += '<td>' + (r.date || '') + '</td>';
        html += '<td>' + (r.department || '') + '</td>';
        html += '<td>' + (r.location || '') + '</td>';
        html += '<td>' + (r.motor || '') + '</td>';
        html += '<td>' + (r.invNumber || '') + '</td>';
        html += '<td>' + (r.manufacturer || '') + '</td>';
        html += '<td>' + (r.power || '') + '</td>';
        html += '<td>' + (r.speed || '') + '</td>';
        html += '<td>' + (r.reason || '') + '</td>';
        html += '<td>' + (r.responsible || '') + '</td>';
        html += '<td>' + (r.phone || '') + '</td>';
        html += '</tr>';
    }

    html += '</tbody></table>';
    container.innerHTML = html;
}

function printHistory() {
    var content = document.getElementById('historyTableContainer').innerHTML;
    var win = window.open('', '_blank');
    win.document.write('<html><head><title>–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</title>');
    win.document.write('<style>');
    win.document.write('body{font-family:Arial,sans-serif;padding:20px;}');
    win.document.write('table{width:100%;border-collapse:collapse;}');
    win.document.write('th,td{border:1px solid #333;padding:6px 8px;font-size:12px;text-align:left;}');
    win.document.write('th{background:#f0f0f0;font-weight:bold;}');
    win.document.write('</style></head><body>');
    win.document.write('<h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π</h2>');
    win.document.write(content);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
}
</script>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 4 –∏–∑ 5
     ============================================================ -->
<!-- ============================================================
     –§–ê–ô–õ: index.html
     –ß–ê–°–¢–¨ 5 –∏–∑ 5: JAVASCRIPT ‚Äî –ù–ê–°–¢–†–û–ô–ö–ò, –ó–ê–ö–†–´–¢–ò–ï –§–ê–ô–õ–ê
     ============================================================ -->
<script>
function openSettings() {
    document.getElementById('settingsModal').style.display = 'flex';
    renderSettings();
}

function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
}

function renderSettings() {
    var grid = document.getElementById('settingsGrid');

    var sections = [
        {key: 'departments', title: 'üè¢ –ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è', type: 'simple'},
        {key: 'locations', title: 'üìç –ú–µ—Å—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏', type: 'locations'},
        {key: 'motors', title: '‚öôÔ∏è –î–≤–∏–≥–∞—Ç–µ–ª–∏', type: 'simple'},
        {key: 'manufacturers', title: 'üè≠ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏', type: 'simple'},
        {key: 'powers', title: '‚ö° –ú–æ—â–Ω–æ—Å—Ç—å (–∫–í—Ç)', type: 'simple'},
        {key: 'speeds', title: 'üîÑ –û–±–æ—Ä–æ—Ç—ã (–æ–±/–º–∏–Ω)', type: 'simple'},
        {key: 'reasons', title: 'üîß –ü—Ä–∏—á–∏–Ω—ã', type: 'simple'}
    ];

    var html = '';
    for (var s = 0; s < sections.length; s++) {
        var sec = sections[s];
        var items = settings[sec.key] || [];
        html += '<div class="settings-section" data-key="' + sec.key + '" data-type="' + sec.type + '">';
        html += '<h3>' + sec.title + '</h3>';
        html += '<div class="settings-list" id="list_' + sec.key + '">';

        for (var i = 0; i < items.length; i++) {
            var displayText = '';
            var itemValue = '';
            if (sec.type === 'locations' && typeof items[i] === 'object') {
                displayText = items[i].name;
                if (items[i].department) {
                    displayText += ' (' + items[i].department + ')';
                }
                itemValue = items[i].name;
            } else {
                displayText = items[i];
                itemValue = items[i];
            }
            html += '<div class="settings-item">';
            html += '<span>' + displayText + '</span>';
            html += '<button onclick="removeItem(this)">‚úï</button>';
            html += '</div>';
        }

        html += '</div>';

        if (sec.type === 'locations') {
            html += '<div style="display:flex;gap:5px;flex-wrap:wrap">';
            html += '<input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="flex:1;min-width:100px;padding:8px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;font-size:13px" id="newLocName_' + sec.key + '">';
            html += '<input type="text" placeholder="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ" style="flex:1;min-width:100px;padding:8px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;font-size:13px" id="newLocDept_' + sec.key + '">';
            html += '<button class="btn btn-success btn-small" onclick="addLocation(\'' + sec.key + '\')">+</button>';
            html += '</div>';
        } else {
            html += '<div style="display:flex;gap:5px">';
            html += '<input type="text" placeholder="–î–æ–±–∞–≤–∏—Ç—å..." style="flex:1;padding:8px;border:1px solid rgba(255,255,255,0.2);border-radius:6px;background:rgba(255,255,255,0.1);color:#fff;font-size:13px" id="newItem_' + sec.key + '">';
            html += '<button class="btn btn-success btn-small" onclick="addItem(\'' + sec.key + '\')">+</button>';
            html += '</div>';
        }

        html += '</div>';
    }

    grid.innerHTML = html;
}

function removeItem(btn) {
    btn.closest('.settings-item').remove();
}

function addItem(key) {
    var input = document.getElementById('newItem_' + key);
    var val = input.value.trim();
    if (!val) return;

    var list = document.getElementById('list_' + key);
    var div = document.createElement('div');
    div.className = 'settings-item';
    div.innerHTML = '<span>' + val + '</span><button onclick="removeItem(this)">‚úï</button>';
    list.appendChild(div);
    input.value = '';
}

function addLocation(key) {
    var nameInput = document.getElementById('newLocName_' + key);
    var deptInput = document.getElementById('newLocDept_' + key);
    var name = nameInput.value.trim();
    var dept = deptInput.value.trim();
    if (!name) return;

    var list = document.getElementById('list_' + key);
    var displayText = name;
    if (dept) {
        displayText += ' (' + dept + ')';
    }
    var div = document.createElement('div');
    div.className = 'settings-item';
    div.setAttribute('data-name', name);
    div.setAttribute('data-dept', dept);
    div.innerHTML = '<span>' + displayText + '</span><button onclick="removeItem(this)">‚úï</button>';
    list.appendChild(div);
    nameInput.value = '';
    deptInput.value = '';
}

function saveSettings() {
    var sections = document.querySelectorAll('.settings-section');
    var promises = [];

    showLoading();

    for (var s = 0; s < sections.length; s++) {
        var sec = sections[s];
        var key = sec.getAttribute('data-key');
        var type = sec.getAttribute('data-type');
        var items = sec.querySelectorAll('.settings-item');
        var values = [];

        for (var i = 0; i < items.length; i++) {
            if (type === 'locations') {
                var dataName = items[i].getAttribute('data-name');
                var dataDept = items[i].getAttribute('data-dept');
                if (dataName) {
                    values.push({name: dataName, department: dataDept || ''});
                } else {
                    var text = items[i].querySelector('span').textContent;
                    var match = text.match(/^(.+?)\s*$(.+)$$/);
                    if (match) {
                        values.push({name: match[1].trim(), department: match[2].trim()});
                    } else {
                        values.push({name: text.trim(), department: ''});
                    }
                }
            } else {
                var text = items[i].querySelector('span').textContent;
                if (text) values.push(text);
            }
        }

        promises.push(
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({action:'updateList', listName: key, items: values})
            }).then(function(r) { return r.json(); })
        );
    }

    Promise.all(promises)
    .then(function(results) {
        hideLoading();
        var hasError = false;
        for (var i = 0; i < results.length; i++) {
            if (!results[i].success) {
                hasError = true;
                notify('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + results[i].error, 'error');
            }
        }
        if (!hasError) {
            notify('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            loadSettings();
        }
    })
    .catch(function(err) {
        hideLoading();
        notify('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    });
}
</script>
</body>
</html>
<!-- ============================================================
     –ö–û–ù–ï–¶ –ß–ê–°–¢–ò 5 –∏–∑ 5
     –ö–û–ù–ï–¶ –§–ê–ô–õ–ê index.html
     ============================================================ -->
